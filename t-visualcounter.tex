% macros=mkvi

%D \module
%D   [     file=t-visualcounter,
%D      version=2011.04.09,
%D        title=\CONTEXT\ User Module,
%D     subtitle=Visual Counter,
%D       author=Aditya Mahajan,
%D         date=\currentdate,
%D    copyright=Aditya Mahajan,
%D        email=adityam <at> ieee <dot> org,
%D      license=Simplified BSD License]

\unprotect

\startinterface all
  \setinterfaceconstant {last}          {last} 
  \setinterfaceconstant {palette}       {palette} 
\stopinterface

\definenamespace
  [visualcounter]
  [   \c!type=module,
      \c!name=visualcounter,
   \c!command=\v!yes,
        setup=\v!list,
     \c!style=\v!yes,
    \s!parent=visualcounter,
  ]

\setupvisualcounter
  [      \s!counter=,
               \c!n={\rawstructurecounter[\visualcounterparameter\s!counter]},
            \c!text={\getstructurecounter[\visualcounterparameter\s!counter]},
      \c!max\c!text={\laststructurecounter[\visualcounterparameter\s!counter]},
            \c!last={\laststructurecounter[\visualcounterparameter\s!counter]},
           \c!style=,
           \c!color=,
              \c!mp=visualcounter:countdown,
         \c!palette=visualcounter:countdown,
           \c!width=1EmWidth,
          \c!height=1ExHeight,
   \c!rulethickness=1bp,
        \c!distance=1cm,
           \c!frame=\v!off,
        \c!location=\v!low,
  ]


\defineframed
  [visualcounterframed]
  [\s!parent=visualcounter,
    \c!width=\v!fit,
   \c!height=\v!fit,
    \c!strut=\v!no,
    \c!frame=\v!off,
   %\c!setups=visualcounter:setups,
  ]


\def\usevisualcounter#{name}%
    {\edef\currentvisualcounter{#{name}}%
     \visualcounterframed
          {\useMPgraphic{\visualcounterparameter\c!mp}}}

\unexpanded\def\getvisualcountertext
    {\dosetvisualcounterattributes\c!style\c!color
     \visualcounterparameter\c!text}

\unexpanded\def\getmaxvisualcountertext
    {\dosetvisualcounterattributes\c!style\c!color
     \visualcounterparameter{\c!max\c!text}}

%D \section {The counters}
%D
%D \subsection {Count down}

\definevisualcounter
  [countdown]
  [      \c!mp=visualcounter:countdown,
    \c!palette=visualcounter:countdown,
      \c!width=1EmWidth,
     \c!height=1ExHeight,
   \c!distance=1cm,
  ]

\definepalet
  [visualcounter:countdown]
  [active=orange,
     past=blue,
   future=gray]

\startMPdefinitions
  % mp-tool does not define new pair.
  def newpair    text v = forsuffixes i=v : save i ; pair    i ; endfor ; enddef ;
\stopMPdefinitions

\startuseMPgraphic{visualcounter:countdown}
  begingroup ;
  save b,c,d,e,n,m,q,s;

  % label
  newpicture countertext     ; countertext     := textext("\getvisualcountertext")    ;
  newpicture max_countertext ; max_countertext := textext("\getmaxvisualcountertext") ;

  newnumeric inner_diameter, outer_diameter ;
  inner_diameter := 1.5 * max(bbwidth(max_countertext), bbheight(max_countertext));
  outer_diameter := inner_diameter + 
          max(\visualcounterparameter\c!width, \visualcounterparameter\c!height) ;

  newpath inner_circle, outer_circle ;
  % make the circle start at 12 o'clock and go clockwise 
  inner_circle := reverse (fullcircle scaled inner_diameter) rotated 90;
  outer_circle := reverse (fullcircle scaled outer_diameter) rotated 90;

  newnumeric n, m ;
  % current count
  n := \visualcounterparameter\c!n ;
  % total count
  m := max(\visualcounterparameter\c!last, 1) ;

  % boundary distance
  newnumeric inner_boundary, outer_boundary ;
  inner_boundary := \visualcounterparameter\c!distance/m * (inner_diameter)/(outer_diameter) ;
  outer_boundary := \visualcounterparameter\c!distance/m ;

  % step size
  newnumeric inner_time, outer_time ;
  inner_time := arclength (inner_circle)/m ;
  outer_time := arclength (outer_circle)/m ;

  newpath slice ;

  newpair pt_inner_left, pt_inner_right ;
  newpair pt_outer_left, pt_outer_right ;

  for i = 1 upto m : 
    pt_inner_left  := point ((i-1)*inner_time)               on inner_circle ;
    pt_inner_right := point (i*inner_time - inner_boundary)  on inner_circle ;

    pt_outer_left  := point ((i-1)*outer_time)               on outer_circle ;
    pt_outer_right := point (i*outer_time - outer_boundary)  on outer_circle ;

    slice := inner_circle cutbefore pt_inner_left cutafter pt_inner_right 
       --- reverse (outer_circle cutbefore pt_outer_left cutafter pt_outer_right ) 
       --- cycle ;

    fill slice withcolor 
      if i < n     : \MPcolor{\visualcounterparameter{\c!palette}:past} 
      elseif i = n : \MPcolor{\visualcounterparameter{\c!palette}:active}
      else         : \MPcolor{\visualcounterparameter{\c!palette}:future}
      fi ;

  endfor ;

  label (countertext, origin) ;

  endgroup ;

\stopuseMPgraphic

%D \subsection {Pulse line}

\definevisualcounter
  [pulseline]
  [           \c!mp=visualcounter:pulseline,
			   path=pulseline:path,
         \c!palette=visualcounter:pulseline,
           \c!width=0.5EmWidth,
          \c!height=3ExHeight,
   \c!rulethickness=1bp,
  ]

\startuseMPgraphic {pulseline:path}
   origin -- (((n-1)*width, 0) .. ((n-0.5)*width, -0.2height) 
		  -- (n*width, height) -- ((n+0.5)*width, -0.2height) 
		  .. ((n+1)*width,0))  -- ((m+1)*width, 0) 
		  randomized 0.3width ;
\stopuseMPgraphic 

\definepalet
  [visualcounter:pulseline]
  [active=lightgreen,
     past=darkgreen,
   future=gray]

\startuseMPgraphic{visualcounter:pulseline}
  begingroup ;

  newnumeric width  ; width  := \visualcounterparameter\c!width ;
  newnumeric height ; height := \visualcounterparameter\c!height ;

  numeric n ; n := \visualcounterparameter\c!n ;
  numeric m ; m := max(\visualcounterparameter\c!last, 5) ;


  newpath pulse ;
  pulse := \includeMPgraphic{\visualcounterparameter{path}} ;

  newpath helper_line ;
  helper_line := (0,-height) -- (0,height) ;

  newpair start_pulse, stop_pulse ;
  start_pulse := pulse intersectionpoint (helper_line shifted ((n-1)*width, 0)) ;
  stop_pulse  := pulse intersectionpoint (helper_line shifted ((n+1)*width, 0)) ;

  
  newpath past_pulse, active_pulse, future_pulse ;
  past_pulse    := pulse cutafter start_pulse ;
  active_pulse  := pulse cutbefore start_pulse cutafter stop_pulse ;
  future_pulse  := pulse cutbefore stop_pulse ;

  pickup pencircle scaled \visualcounterparameter\c!rulethickness ;
  draw past_pulse   withcolor \MPcolor{\visualcounterparameter{\c!palette}:past}   ;
  draw active_pulse withcolor \MPcolor{\visualcounterparameter{\c!palette}:active} ;
  draw future_pulse withcolor \MPcolor{\visualcounterparameter{\c!palette}:future} ;

  endgroup ;
\stopuseMPgraphic

%D \subsection {Scratch Marks}

\definevisualcounter
  [scratchmarks]
  [           \c!mp=visualcounter:scratchmarks,
         \c!palette=visualcounter:scratchmarks,
           \c!width=0.5EmWidth,
          \c!height=3ExHeight,
			  angle=75,
   \c!rulethickness=3bp,
  ]

\definepalet
  [visualcounter:scratchmarks]
  [active=orange,
     past=blue,
   future=gray]

\startuseMPgraphic{visualcounter:scratchmarks}
  begingroup ;

  linecap := rounded ;

  newnumeric width  ; width  := \visualcounterparameter\c!width ;
  newnumeric height ; height := \visualcounterparameter\c!height ;
  newnumeric theta  ; theta  := \visualcounterparameter{angle} ;

  numeric n ; n := \visualcounterparameter\c!n ;
  numeric m ; m := max(\visualcounterparameter\c!last, 1) ;


  newpath left_marker, right_marker ;

  left_marker   := origin -- height*dir(theta) ;
  right_marker  := (-4*width, height*sind(theta)) -- origin ;

  save marker ;
  def marker (expr i) =
	(if i mod 5 = 0 : right_marker else : left_marker fi) 
		shifted (i*width, 0) 
		withcolor
			if i < n     : \MPcolor{\visualcounterparameter{\c!palette}:past} 
			elseif i = n : \MPcolor{\visualcounterparameter{\c!palette}:active}
			else         : \MPcolor{\visualcounterparameter{\c!palette}:future}
			fi ;
  enddef ;

  pickup pencircle scaled \visualcounterparameter\c!rulethickness ;

  for i := m downto 1 :
	  draw marker(i) ;
  endfor ;

  draw marker(n) ;

  endgroup ;
\stopuseMPgraphic



\protect


