\unprotect

\startinterface all
  \setinterfaceconstant {last}          {last} 
  \setinterfaceconstant {palette}       {palette} 
\stopinterface

\definenamespace
  [VISUALCOUNTER]
  [\c!type=module,
   \c!name=visualcounter,
   \c!command=\v!list,
   setup=\v!list,
   \c!style=\v!yes,
   \s!parent=VISUALCOUNTER]

\setupvisualcounter
  [\s!counter=userpage,
   \c!n={\rawstructurecounter[\visualcounterparameter\s!counter]},
   \c!text={\getstructurecounter[\visualcounterparameter\s!counter]},
   \c!max\c!text={\laststructurecounter[\visualcounterparameter\s!counter]},
   \c!last={\laststructurecounter[\visualcounterparameter\s!counter]},
   \c!style=,
   \c!color=,
   \c!mp=visualcounter:countdown,
   \c!palette=visualcounter:default,
   \c!width=1EmWidth,
   \c!height=1ExHeight,
   \c!rulethickness=1bp,
   \c!distance=1cm,
   \c!frame=\v!off,
   \c!location=\v!low,
 ]

\definepalet
  [visualcounter:default]
  [active=orange,
   past=blue,
   future=gray]

\defineframed
  [visualcounterframed]
  [\s!parent=\????VISUALCOUNTER,
   \c!width=\v!fit,
   \c!height=\v!fit,
   \c!strut=\v!no,
  ]

\def\usevisualcounter#1%
  {\edef\currentVISUALCOUNTER{#1}%
   \visualcounterframed
    {\setuppalet[\visualcounterparameter\c!palette]%
     \useMPgraphic{\visualcounterparameter\c!mp}}}

\unexpanded\def\getvisualcountertext
  {\dosetvisualcounterattributes\c!style\c!color
    \visualcounterparameter\c!text}

\unexpanded\def\getmaxvisualcountertext
  {\dosetvisualcounterattributes\c!style\c!color
    \visualcounterparameter{\c!max\c!text}}

\startuseMPgraphic{visualcounter:countdown}
  save b,c,d,e,n,m,p,q,s;

  % label
  picture p[]; 
  
  p.1 := textext("\getvisualcountertext") ;
  p.2 := textext("\getmaxvisualcountertext") ;

  numeric d[] ;

  % diameter of circles
  d.1 := 1.5 * max(bbwidth(p.2), bbheight(p.2));
  d.2 := d.1 + max(\visualcounterparameter\c!width, 
                   \visualcounterparameter\c!height) ;

  path c[] ;
  % make the circle start at 12 o'clock and go clockwise 
  c.1 := reverse (fullcircle scaled d.1) rotated 90;
  c.2 := reverse (fullcircle scaled d.2) rotated 90;

  numeric b[],t[],n,m ;
  % current count
  n := \visualcounterparameter\c!n ;
  % total count
  m := \visualcounterparameter\c!last ;
  if m = 0 : m := 1 ; fi ;

  % boundary distance
  b.1 := \visualcounterparameter\c!distance/m*d.1/d.2 ;
  b.2 := \visualcounterparameter\c!distance/m ;

  % step size
  t.1 := arclength (c.1)/m ;
  t.2 := arclength (c.2)/m ;

  pair q[] ;
  path s ;
  for i = 1 upto m : 
    q.1 := point ((i-1)*t.1)        on c.1 ;
    q.2 := point (i*t.1 - b.1)  on c.1 ;

    q.3 := point ((i-1)*t.2)        on c.2 ;
    q.4 := point (i*t.2 - b.2)  on c.2 ;

    s := c.1 cutbefore q.1 cutafter q.2 -- q.2 -- q.4
       -- reverse (c.2 cutbefore q.3 cutafter q.4 ) -- q.3 -- q.1 
       -- cycle ;

    fill s withcolor 
      if i < n     : \MPcolor{past} 
      elseif i = n : \MPcolor{active}
      else         : \MPcolor{future}
      fi ;

  endfor ;

  label (p.1, origin) ;

\stopuseMPgraphic

\startuseMPgraphic{visualcounter:pulseline}
  save h,n,m,p,w ;

  numeric w ; w := \visualcounterparameter\c!width ;
  numeric h ; h := \visualcounterparameter\c!height ;

  numeric n ; n := \visualcounterparameter\c!n ;
  numeric m ; m := \visualcounterparameter\c!last ;

  draw (0,0) -- ((n-1)*w, 0) 
      withpen pencircle scaled \visualcounterparameter\c!rulethickness\space
      withcolor \MPcolor{past} ;

  draw ((n-1)*w, 0) -- ((n-0.5)*w, -0.2h) -- (n*w, h) -- ((n+0.5)*w, -0.2h) -- ((n+1)*w,0)
      withpen pencircle scaled \visualcounterparameter\c!rulethickness\space
      withcolor \MPcolor{active} ;

  draw ((n+1)*w, 0) -- ((m+1)*w, 0)
      withpen pencircle scaled \visualcounterparameter\c!rulethickness\space
      withcolor \MPcolor{future} ;

\stopuseMPgraphic

\protect
